# Этап 2: Исправление кнопок шаринга и инициализации

**Дата**: 2025-01-27

## Что было

После перехода на URL-based мультиязычность и рефакторинга кода возникли проблемы:
- Кнопки не работали (ни "Начать тест", ни кнопки шаринга)
- При локальной разработке кнопки шаринга пытались открыть `file:///D:/dev/...` вместо продакшн URL
- В Twitter и Facebook появлялись дублирующиеся ссылки
- Ошибка при инициализации: `Cannot set properties of null (setting 'textContent')` для несуществующего элемента `pageTitle`

## Решение

### 1. Исправлена инициализация обработчиков событий

**Проблема**: Элементы получались до загрузки DOM, обработчики не привязывались.

**Решение**:
- Все элементы теперь получаются в функции `init()` после загрузки DOM
- Добавлена проверка загрузки `translations.js` перед инициализацией
- Добавлен флаг `isInitialized` для предотвращения двойной инициализации
- Все обработчики событий обернуты в функции с логированием для отладки

```javascript
// Инициализация при загрузке DOM
function doInit() {
    if (isInitialized) return;
    
    if (typeof getCurrentLanguage === 'undefined' || typeof getQuestions === 'undefined') {
        console.error('❌ translations.js не загружен!');
        return;
    }
    
    isInitialized = true;
    init();
}
```

### 2. Исправлена ошибка с pageTitle

**Проблема**: Код пытался установить `textContent` для несуществующего элемента `pageTitle`.

**Решение**:
- Добавлены проверки на существование элементов перед установкой свойств
- Исправлена работа с meta-тегами (используется `setAttribute` вместо `.content`)
- Добавлен fallback на `document.title`, если элемент не найден

```javascript
const pageTitle = document.getElementById('pageTitle');
const pageDescription = document.querySelector('meta[name="description"]');
const pageKeywords = document.querySelector('meta[name="keywords"]');

if (pageTitle) pageTitle.textContent = '...';
else if (document.title) document.title = '...';
```

### 3. Исправлены URL для шаринга при локальной разработке

**Проблема**: При локальной разработке `window.location.href` возвращал `file:///D:/dev/...`, который социальные сети не могут обработать.

**Решение**:
- Функции `getShareUrl()` и `getStartPageShareUrl()` теперь проверяют, является ли текущий URL локальным файлом
- Если да, используется продакшн URL (`https://iqtest-1id.pages.dev`)
- Язык определяется из пути файла

```javascript
function getShareUrl() {
    const productionUrl = 'https://iqtest-1id.pages.dev';
    const isLocal = window.location.protocol === 'file:';
    
    let baseUrl;
    if (isLocal) {
        baseUrl = productionUrl + '/ru/index.html';
    } else {
        baseUrl = window.location.origin + window.location.pathname;
    }
    // ...
}
```

### 4. Убрано дублирование ссылок в Twitter и Facebook

**Проблема**: URL добавлялся и в текст сообщения, и в параметр `url`/`u`, что приводило к дублированию ссылок в посте.

**Решение**:
- Убран URL из текста в функциях `shareToTwitter()` и `shareToTwitterStart()`
- Убран URL из параметра `quote` в функциях `shareToFacebook()` и `shareToFacebookStart()`
- Социальные сети сами добавляют ссылку из параметра `url`/`u`

```javascript
function shareToTwitter() {
    const url = getShareUrl();
    const text = getShareText(); // URL не добавляем в текст
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, ...);
}
```

## Почему такое решение

- **Проверка загрузки translations.js**: Гарантирует, что функции переводов доступны перед использованием
- **Флаг isInitialized**: Предотвращает множественные вызовы инициализации, которые могут привести к дублированию обработчиков
- **Продакшн URL для локальной разработки**: Позволяет тестировать шаринг локально без необходимости деплоя
- **Убрать URL из текста**: Социальные сети сами форматируют ссылки, дублирование выглядит некрасиво

## Плюсы

- ✅ Все кнопки теперь работают корректно
- ✅ Шаринг работает как локально, так и в продакшене
- ✅ Нет дублирования ссылок в постах
- ✅ Добавлено логирование для отладки
- ✅ Код более надежный (проверки на существование элементов)

## Минусы

- ❌ Хардкод продакшн URL в коде (можно было бы вынести в конфиг)
- ❌ Логирование в консоль остается в продакшене (можно было бы убрать в production build)

## Подводные камни

- **Порядок загрузки скриптов**: Важно, чтобы `translations.js` загружался перед `script.js`
- **Локальная разработка**: При тестировании шаринга локально нужно помнить, что используется продакшн URL
- **Дублирование обработчиков**: Если `init()` вызывается несколько раз, обработчики могут дублироваться (исправлено флагом)

## Что сделано

- ✅ Исправлена инициализация обработчиков событий (добавлена проверка загрузки DOM и translations.js)
- ✅ Исправлена ошибка с `pageTitle` (добавлены проверки на существование элементов)
- ✅ Исправлены URL для шаринга при локальной разработке (используется продакшн URL)
- ✅ Убрано дублирование ссылок в Twitter и Facebook
- ✅ Добавлено логирование для отладки работы кнопок
- ✅ Добавлен флаг для предотвращения двойной инициализации

## Скриншоты

*Скриншоты исправлений не требуются, так как визуально интерфейс не изменился - исправлена только функциональность*


